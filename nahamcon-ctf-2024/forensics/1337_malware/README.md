## forensics/1337_malware

We received a plea for help from a rather frustrated looking employee. He said he accidently ran malware on his computer, but when he tried to pay the "leet hacker" to get his files back they said the malware was "broken"... best IT could do was provide us a PCAP.  
**Given:** 1337_malware.pcapng

## Solution

The given pcap file contains network traffic from a supposed to be randomware. On analyzing it in Wireshark, we can see 11 TCP streams to C2 server. The first TCP stream contains the downloaded randomsware.

![Ransomware code](rans.png)

The ransomware generates a random 32 bytes key and encrypts all the files in disk with One-Time Pad encryption. Since the key is not tranmistted, we don't have the key in pcap.

The following 10 TCP streams corresponds to 5 files uploaded to C2 server. The file contents are encrypted.
```
TCP stream 1:  /home/davey/Documents/resources.zip
TCP stream 2:  < encrypted resources.zip >
TCP stream 3:  /home/davey/Documents/ecorp.png
TCP stream 4:  < encrypted ecorp.png >
TCP stream 5:  /home/davey/Documents/Welcome Aboard.pdf
TCP stream 6:  < encrypted "Welcome Aboard.pdf" >
TCP stream 7:  /home/davey/Documents/.ssh/id_rsa
TCP stream 8:  < encrypted id_rsa >
TCP stream 9:  /home/davey/Documents/.ssh/id_rsa.pub
TCP stream 10: < encrypted id_rsa.pub >
```
Among the 5 files, `id_rsa` is interesting as we know how ssh private key files start. PEM private key files contain first line as
```
-----BEGIN OPENSSH PRIVATE KEY-----
```

Hence we can xor first 32 bytes of  `< encrypted id_rsa >` with `-----BEGIN OPENSSH PRIVATE KEY--` to find the key.

We can use Cyberchef to perform xor and find the key.

![XOR key](xor-key.png)

Next step is to decrypt `resources.zip, ecorp.png, Welcome Aboard.pdf` using XOR key that we got.

Once decrypted, resources.zip seems to have flag.txt. But it is password protected. The password to open resources.zip is found in "Welcome Aboard.pdf". 

![ecorp.png](ecorp-dec.png)

To get flag
```bash
# Copy password from "Welcome Aboard.pdf"
unzip resources.png
cat flag.txt
```